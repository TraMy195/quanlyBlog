@model Blog.Models.Post

@{
    ViewData["Title"] = Model.Title;
}

<div class="container my-5">
    <!-- Bài viết chính -->
    <div class="card border-0 shadow-lg rounded-4 overflow-hidden mb-5">
        <!-- Ảnh cover -->
        @if (!string.IsNullOrEmpty(Model.ImagePath))
        {
            <img src="~/images/@Model.ImagePath"
                 class="card-img-top"
                 alt="@Model.Title"
                 style="height: 400px; object-fit: cover;" />
        }

        <div class="card-body p-5">
            <!-- Tiêu đề -->
            <h1 class="fw-bold text-primary mb-4">@Model.Title</h1>

            <!-- Thông tin bài viết -->
            <div class="d-flex flex-wrap gap-4 mb-4 text-muted">
                <span><i class="bi bi-folder2-open me-1"></i> @Model.Category?.Name</span>
                <span>
                    <i class="bi bi-person me-1"></i>
                    <a asp-controller="Editor" asp-action="Profile" asp-route-id="@Model.AuthorId" class="text-primary text-decoration-none">
                        @Model.Author?.Username
                    </a>
                </span>
                <span><i class="bi bi-calendar-event me-1"></i> @Model.CreatedAt.ToString("dd/MM/yyyy HH:mm")</span>
                <span><i class="bi bi-eye me-1"></i> @Model.Views lượt xem</span>
            </div>

            <!-- Nội dung -->
            <div class="article-content lead lh-lg">
                @Html.Raw(Model.Content.Replace("\n", "<br />"))
            </div>
        </div>
    </div>

    <!-- Phần bình luận -->
    <div class="card border-0 shadow rounded-4">
        <div class="card-header bg-light text-center py-3">
            <h4 class="mb-0 fw-bold text-primary">Bình luận (@Model.Comments?.Count)</h4>
        </div>

        <div class="card-body p-4">
            <!-- Form thêm bình luận -->
            @if (User.Identity?.IsAuthenticated == true)
            {
                <form asp-controller="Comment" asp-action="Create" method="post" class="mb-5">
                    <input type="hidden" name="postId" value="@Model.PostId" />

                    <div class="mb-3">
                        <textarea name="content" class="form-control" rows="4" 
                                  placeholder="Nhập bình luận của bạn..." required></textarea>
                    </div>

                    <button type="submit" class="btn btn-primary px-5 rounded-pill">
                        <i class="bi bi-send-fill me-2"></i> Gửi bình luận
                    </button>
                </form>
            }
            else
            {
                <div class="alert alert-info text-center">
                    <i class="bi bi-lock me-2"></i>
                    <a asp-controller="Account" asp-action="Login" class="text-primary fw-bold text-decoration-none">
                        Đăng nhập
                    </a> để tham gia bình luận nhé!
                </div>
            }

            <!-- Danh sách bình luận -->
            @if (Model.Comments != null && Model.Comments.Any())
            {
                <div class="mt-5">
                    @foreach (var c in Model.Comments.OrderByDescending(x => x.CreatedAt))
                    {
                        <div class="d-flex mb-4 border-bottom pb-4">
                            <!-- Avatar bình luận -->
                            <img src="~/avatars/@(c.User?.AvatarPath ?? "default.png")"
                                 class="rounded-circle me-3"
                                 alt="@c.User?.Username"
                                 style="width: 50px; height: 50px; object-fit: cover; border: 2px solid #eee;" />

                            <!-- Nội dung bình luận -->
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <strong class="text-dark">@c.User?.Username</strong>
                                    <small class="text-muted">
                                        @c.CreatedAt.ToString("dd/MM/yyyy HH:mm")
                                    </small>
                                </div>

                                <p class="mb-2" id="content-@c.CommentId">@c.Content</p>

                                @if (User.Identity?.IsAuthenticated == true && 
                                     User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value == c.UserId.ToString())
                                {
                                    <div class="d-flex gap-3">
                                        <button class="btn btn-sm btn-warning" 
                                                onclick="openEditModal(@c.CommentId)">
                                            <i class="bi bi-pencil"></i> Sửa
                                        </button>

                                        <form asp-controller="Comment" asp-action="Delete" method="post" class="d-inline">
                                            <input type="hidden" name="commentId" value="@c.CommentId" />
                                            <button type="submit" class="btn btn-sm btn-danger"
                                                    onclick="return confirm('Xóa bình luận này?')">
                                                <i class="bi bi-trash"></i> Xóa
                                            </button>
                                        </form>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="text-center py-5 text-muted">
                    <i class="bi bi-chat-square-dots fs-1 mb-3 d-block"></i>
                    <p class="mb-0">Chưa có bình luận nào. Bạn là người đầu tiên nhé!</p>
                </div>
            }
        </div>
    </div>
</div>

<!-- Modal sửa bình luận -->
<div class="modal fade" id="editCommentModal" tabindex="-1" aria-labelledby="editCommentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-controller="Comment" asp-action="Edit" method="post">
                <div class="modal-header">
                    <h5 class="modal-title" id="editCommentModalLabel">✏️ Sửa bình luận</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="commentId" id="editCommentId" />
                    <textarea name="content" id="editCommentContent" class="form-control" rows="5" required></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-primary">Lưu thay đổi</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        function openEditModal(commentId) {
            const contentElement = document.getElementById('content-' + commentId);
            const content = contentElement.innerText;

            document.getElementById('editCommentId').value = commentId;
            document.getElementById('editCommentContent').value = content;

            const modal = new bootstrap.Modal(document.getElementById('editCommentModal'));
            modal.show();
        }
    </script>
}

<style>
    .bg-gradient-primary {
        background: linear-gradient(135deg, #4dabf7 0%, #228be6 100%);
    }
    .article-content {
        line-height: 1.8;
        font-size: 1.1rem;
    }
    .card {
        box-shadow: 0 10px 30px rgba(77,171,247,0.1);
    }
    .btn-primary {
        background: linear-gradient(135deg, #4dabf7, #228be6);
        border: none;
    }
    .btn-primary:hover {
        background: linear-gradient(135deg, #228be6, #1c7ed6);
    }
</style>